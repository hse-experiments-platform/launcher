-- launches schema
-- create table if not exists launches
-- (
--     id            bigint primary key generated by default as identity,
--     launch_type   text                     not null,
--     user_id       bigint                   not null references users (id),
--     name          text                     not null,
--     description   text                     not null,
--     created_at    timestamp with time zone not null default now(),
--     updated_at    timestamp with time zone not null default now(),
--     finished_at   timestamp with time zone,
--     launch_status text                     not null,
--     launch_error  text
-- );


-- name: GetLaunches :many
select *,
       count(1) over () as count
from launches
where name like '%' || sqlc.arg(name) || '%'
  and (launch_type = $4 or $4 = '')
  and user_id = $5
order by created_at desc
limit $1 offset $2;

-- name: GetDatasetCreator :one
select creator_id
from datasets
where id = $1;

-- name: CreateLaunch :one
insert into launches (launch_type, user_id, name, description, launch_status)
values ($1, $2, $3, $4, $5)
returning id;

-- name: UpdateLaunchStatus :exec
update launches
set launch_status = $2,
    updated_at = now()
where id = $1;

-- name: FinishLaunch :exec
update launches
set launch_status = $2,
    updated_at = now(),
    finished_at = now(),
    launch_error = $3
where id = $1;

